{"version":3,"sources":["../src/captchas/turnstile.ts"],"sourcesContent":["import got from 'got'\nimport { TurnstileConfig, TurnstileValidateResult } from '../types.js'\nimport { Captcha } from './captcha.js'\nimport { HttpContext } from '@adonisjs/core/http'\nimport * as errors from '../errors.js'\n\n/**\n * See more info about Cloudflare Turnstile server-side validation: https://developers.cloudflare.com/turnstile/get-started/server-side-validation/\n */\nexport class TurnstileService extends Captcha {\n    protected verifyUrl = 'https://challenges.cloudflare.com/turnstile/v0/siteverify'\n\n    protected tokenParamName = 'token'\n\n    constructor(ctx: HttpContext, public config: TurnstileConfig) {\n        super(ctx, config)\n    }\n\n    public async validate(): Promise<TurnstileValidateResult> {\n        if (!this.hasToken()) {\n            throw new errors.E_CAPTCHA_MISSING_TOKEN([this.tokenParamName])\n        }\n\n        const token = this.getToken()\n        const body = await got.post(\n          this.verifyUrl,\n          {\n            json: {\n              secret: this.config.secret,\n              response: token,\n            }\n          }\n        ).text()\n        const decodeBody = JSON.parse(body)\n        return {\n          success: Boolean(decodeBody.success),\n          challengeTimestamp: decodeBody.challenge_ts,\n          hostname: decodeBody.hostname,\n          errorCodes: decodeBody['error-codes'],\n          action: decodeBody.action,\n          cdata: decodeBody.cdata,\n        } as TurnstileValidateResult\n    }\n}"],"mappings":";;;;;;;;AAAA,OAAO,SAAS;AAST,IAAM,mBAAN,cAA+B,QAAQ;AAAA,EAK1C,YAAY,KAAyB,QAAyB;AAC1D,UAAM,KAAK,MAAM;AADgB;AAAA,EAErC;AAAA,EANU,YAAY;AAAA,EAEZ,iBAAiB;AAAA,EAM3B,MAAa,WAA6C;AACtD,QAAI,CAAC,KAAK,SAAS,GAAG;AAClB,YAAM,IAAW,wBAAwB,CAAC,KAAK,cAAc,CAAC;AAAA,IAClE;AAEA,UAAM,QAAQ,KAAK,SAAS;AAC5B,UAAM,OAAO,MAAM,IAAI;AAAA,MACrB,KAAK;AAAA,MACL;AAAA,QACE,MAAM;AAAA,UACJ,QAAQ,KAAK,OAAO;AAAA,UACpB,UAAU;AAAA,QACZ;AAAA,MACF;AAAA,IACF,EAAE,KAAK;AACP,UAAM,aAAa,KAAK,MAAM,IAAI;AAClC,WAAO;AAAA,MACL,SAAS,QAAQ,WAAW,OAAO;AAAA,MACnC,oBAAoB,WAAW;AAAA,MAC/B,UAAU,WAAW;AAAA,MACrB,YAAY,WAAW,aAAa;AAAA,MACpC,QAAQ,WAAW;AAAA,MACnB,OAAO,WAAW;AAAA,IACpB;AAAA,EACJ;AACJ;","names":[]}