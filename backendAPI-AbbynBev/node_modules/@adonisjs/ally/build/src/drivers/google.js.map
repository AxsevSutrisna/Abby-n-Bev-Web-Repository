{"version":3,"sources":["../../../src/drivers/google.ts"],"sourcesContent":["/*\n * @adonisjs/ally\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type { HttpContext } from '@adonisjs/core/http'\nimport type { HttpClient } from '@poppinss/oauth-client'\nimport type {\n  GoogleToken,\n  GoogleScopes,\n  GoogleDriverConfig,\n  ApiRequestContract,\n  RedirectRequestContract,\n} from '../types.js'\nimport { Oauth2Driver } from '../abstract_drivers/oauth2.js'\n\nconst SCOPE_PREFIXES = {\n  'https://www.googleapis.com/auth': [\n    'userinfo.email',\n    'userinfo.profile',\n    'contacts',\n    'contacts.other.readonly',\n    'contacts.readonly',\n    'directory.readonly',\n    'user.addresses.read',\n    'user.birthday.read',\n    'user.emails.read',\n    'user.gender.read',\n    'user.organization.read',\n    'user.phonenumbers.read',\n    'analytics',\n    'analytics.readonly',\n    'documents',\n    'documents.readonly',\n    'forms',\n    'forms.currentonly',\n    'groups',\n    'spreadsheets',\n    'calendar',\n    'calendar.events',\n    'calendar.events.readonly',\n    'calendar.readonly',\n    'calendar.settings.readonly',\n    'drive',\n    'drive.appdata',\n    'drive.file',\n    'drive.metadata',\n    'drive.metadata.readonly',\n    'drive.photos.readonly',\n    'drive.readonly',\n    'drive.scripts',\n  ],\n}\n\n/**\n * Google driver to login user via Google\n */\nexport class GoogleDriver extends Oauth2Driver<GoogleToken, GoogleScopes> {\n  protected accessTokenUrl = 'https://oauth2.googleapis.com/token'\n  protected authorizeUrl = 'https://accounts.google.com/o/oauth2/v2/auth'\n  protected userInfoUrl = 'https://www.googleapis.com/oauth2/v3/userinfo'\n\n  /**\n   * The param name for the authorization code\n   */\n  protected codeParamName = 'code'\n\n  /**\n   * The param name for the error\n   */\n  protected errorParamName = 'error'\n\n  /**\n   * Cookie name for storing the \"google_oauth_state\"\n   */\n  protected stateCookieName = 'google_oauth_state'\n\n  /**\n   * Parameter name to be used for sending and receiving the state\n   * from google\n   */\n  protected stateParamName = 'state'\n\n  /**\n   * Parameter name for defining the scopes\n   */\n  protected scopeParamName = 'scope'\n\n  /**\n   * Scopes separator\n   */\n  protected scopesSeparator = ' '\n\n  constructor(\n    ctx: HttpContext,\n    public config: GoogleDriverConfig\n  ) {\n    super(ctx, config)\n    /**\n     * Extremely important to call the following method to clear the\n     * state set by the redirect request\n     */\n    this.loadState()\n  }\n\n  /**\n   * Configuring the redirect request with defaults\n   */\n  protected configureRedirectRequest(request: RedirectRequestContract<GoogleScopes>) {\n    request.transformScopes((scopes) => this.buildScopes(scopes))\n\n    /**\n     * Define user defined scopes or the default one's\n     */\n    request.scopes(this.config.scopes || ['openid', 'userinfo.email', 'userinfo.profile'])\n\n    /**\n     * Set \"response_type\" param\n     */\n    request.param('response_type', 'code')\n\n    /**\n     * Define params based upon user config\n     */\n    if (this.config.accessType) {\n      request.param('access_type', this.config.accessType)\n    }\n    if (this.config.prompt) {\n      request.param('prompt', this.config.prompt)\n    }\n    if (this.config.display) {\n      request.param('display', this.config.display)\n    }\n    if (this.config.hostedDomain) {\n      request.param('hd', this.config.hostedDomain)\n    }\n  }\n\n  /**\n   * Returns the HTTP request with the authorization header set\n   */\n  protected getAuthenticatedRequest(url: string, token: string): HttpClient {\n    const request = this.httpClient(url)\n    request.header('Authorization', `Bearer ${token}`)\n    request.header('Accept', 'application/json')\n    request.parseAs('json')\n    return request\n  }\n\n  /**\n   * Fetches the user info from the Google API\n   */\n  protected async getUserInfo(token: string, callback?: (request: ApiRequestContract) => void) {\n    const request = this.getAuthenticatedRequest(this.config.userInfoUrl || this.userInfoUrl, token)\n    if (typeof callback === 'function') {\n      callback(request)\n    }\n\n    const body = await request.get()\n\n    return {\n      id: body.sub,\n      nickName: body.name,\n      name: body.name,\n      email: body.email,\n      avatarUrl: body.picture,\n      emailVerificationState: body.email_verified ? ('verified' as const) : ('unverified' as const),\n      original: body,\n    }\n  }\n\n  /**\n   * Find if the current error code is for access denied\n   */\n  accessDenied(): boolean {\n    const error = this.getError()\n    if (!error) {\n      return false\n    }\n\n    return error === 'access_denied'\n  }\n\n  /**\n   * Get access token\n   */\n  async accessToken(callback?: (request: ApiRequestContract) => void): Promise<GoogleToken> {\n    const token = await super.accessToken(callback)\n\n    return {\n      ...token,\n      idToken: token.id_token,\n    }\n  }\n\n  /**\n   * Returns details for the authorized user\n   */\n  async user(callback?: (request: ApiRequestContract) => void) {\n    const token = await this.accessToken(callback)\n    const user = await this.getUserInfo(token.token, callback)\n\n    return {\n      ...user,\n      token: token,\n    }\n  }\n\n  /**\n   * Finds the user by the access token\n   */\n  async userFromToken(token: string, callback?: (request: ApiRequestContract) => void) {\n    const user = await this.getUserInfo(token, callback)\n\n    return {\n      ...user,\n      token: { token, type: 'bearer' as const },\n    }\n  }\n\n  /**\n   * Prefixes google scopes with the url\n   */\n  buildScopes(scopes: string[]) {\n    return scopes.map((name) => {\n      const prefix = Object.keys(SCOPE_PREFIXES).find((one) =>\n        SCOPE_PREFIXES[one as keyof typeof SCOPE_PREFIXES].includes(name)\n      )\n      return prefix ? `${prefix}/${name}` : name\n    })\n  }\n}\n"],"mappings":"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","names":[]}